---
import type {
    ButtonFragment,
    DisplaySettingsFragment,
} from '../../../../__generated/sdk';
import type { ContentPayload } from '../../../graphql/shared/ContentPayload';
import LinkButton from './LinkButton.astro';
import { getButtonStyles } from './ButtonStyling';
import { getLoginButtonStyles } from './LoginButtonStyling';
import { isEditContext, getLink } from '../../shared/utils.ts';
import type { ButtonLinkData } from '../../shared/utils.ts';

const isCmsEdit = isEditContext(Astro.url);

export interface Props {
    key: string;
    data: ButtonFragment;
    displaySettings: DisplaySettingsFragment[];
    displayTemplateKey: string;
    contentPayload: ContentPayload;
}
const { key, data, displaySettings, displayTemplateKey, contentPayload } = Astro.props as Props;

const isDefaultButton = displayTemplateKey === 'DefaultButton';
const isLoginButton = displayTemplateKey === 'LoginButton';

let btnStyles: string | string[] | {} = '';
let loginButtonSlot: string = '';

if(isLoginButton) {
    const { btnStyles: loginBtnStyles, loginButtonSlot: loginBtnSlot } = getLoginButtonStyles(displaySettings);
    btnStyles = loginBtnStyles;
    loginButtonSlot = loginBtnSlot;
} else {
    btnStyles = getButtonStyles(displaySettings);
}

const currentDomain = Astro.url.origin;
const safeButtonLink: ButtonLinkData = {
    url: {
        hierarchical: data?.ButtonLink?.url?.hierarchical ?? '#',
        default: data?.ButtonLink?.url?.default ?? '#',
        type: data?.ButtonLink?.url?.type ?? 'HIERARCHICAL',
        base: data?.ButtonLink?.url?.base ?? currentDomain,
    }
};
const buttonLink = getLink(safeButtonLink, currentDomain);

const componentClass = 'component-button';
---
{ isDefaultButton &&
    <span data-epi-block-id={isCmsEdit && key || undefined} class={componentClass}>
        <LinkButton cssClasses={btnStyles} link={buttonLink}>{data?.ButtonLabel}</LinkButton>
    </span>
}
{ isLoginButton &&
    <span data-epi-block-id={isCmsEdit && key || undefined} class={componentClass}>
        <LinkButton cssClasses={btnStyles} link={buttonLink}><Fragment set:html={loginButtonSlot}/></LinkButton>
    </span>
}