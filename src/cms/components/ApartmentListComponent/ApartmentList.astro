---
import type {
    ApartmentListFragment,
    DisplaySettingsFragment,
} from '../../../../__generated/sdk';
import { getOptimizelySdk } from '../../../graphql/getSdk';
import type { ContentPayload } from '../../../graphql/shared/ContentPayload';
import { isEditContext } from '../../shared/utils.ts';
import ApartmentListFilter from './ApartmentListFilter.svelte';

const isCmsEdit = isEditContext(Astro.url);

export interface Props {
    key: string;
    data: ApartmentListFragment;
    displaySettings: DisplaySettingsFragment[];
    displayTemplateKey: string;
    contentPayload: ContentPayload;
}

const { key, data, displaySettings, displayTemplateKey, contentPayload } = Astro.props as Props;

// null/empty = return all apartments; otherwise use the editor-configured limit
const requestedLimit = data.NumberOfApartments || 0; // 0 = all

// Fetch in batches of 100 (Graph max limit), collecting up to requestedLimit items
const sdk = getOptimizelySdk(contentPayload);
const PAGE_SIZE = 100;
const allItems: any[] = [];

const firstPage = await sdk.getApartments({ limit: Math.min(PAGE_SIZE, requestedLimit || PAGE_SIZE) });
const total = firstPage?.Apartments?.total || 0;
allItems.push(...(firstPage?.Apartments?.items || []));

const target = requestedLimit || total; // how many items we actually want
if (target > allItems.length && total > allItems.length) {
    const remaining = Math.ceil((Math.min(target, total) - allItems.length) / PAGE_SIZE);
    const pages = await Promise.all(
        Array.from({ length: remaining }, (_, i) =>
            sdk.getApartments({ limit: PAGE_SIZE, skip: (i + 1) * PAGE_SIZE })
        )
    );
    for (const page of pages) {
        allItems.push(...(page?.Apartments?.items || []));
    }
}

const initialItems = requestedLimit ? allItems.slice(0, requestedLimit) : allItems;
const initialTotal = total;
const initialFacets = {
    cities: (firstPage?.Apartments?.facets?.apartment_city || []).filter((f: any) => f?.name),
    states: (firstPage?.Apartments?.facets?.apartment_state || []).filter((f: any) => f?.name),
    communities: (firstPage?.Apartments?.facets?.apartment_community_name || []).filter((f: any) => f?.name),
    parkingTypes: (firstPage?.Apartments?.facets?.apartment_parking_type || []).filter((f: any) => f?.name),
};
const limit = requestedLimit || total;
---

<div data-epi-block-id={isCmsEdit && key || undefined} class="component-apartmentlist">
    <ApartmentListFilter
        client:load
        limit={limit}
        initialItems={initialItems}
        initialTotal={initialTotal}
        initialFacets={initialFacets}
    />
</div>
