---
// /src/pages/opti-admin/graph-synonyms.astro
import AdminLayout from '../../layouts/AdminLayout.astro';
import { checkAdminAuth } from '../../../utils/admin-auth';

// Check authentication
const authError = checkAdminAuth(Astro.request);
if (authError) {
    return authError;
}
---

<AdminLayout title="Optimizely Graph - Synonyms Manager">
  <div class="max-w-4xl">
    <div class="mb-8">
      <h1 class="text-3xl font-bold text-gray-900 mb-2">Synonyms Manager</h1>
      <p class="text-gray-600">Manage synonym configurations for Optimizely Graph search functionality.</p>
    </div>
    
    <div class="bg-blue-50 border-l-4 border-blue-400 p-4 mb-6">
      <h2 class="text-lg font-semibold text-blue-800 mb-2">Synonym Formats</h2>
      <div class="text-sm text-blue-700">
        <p class="mb-2"><strong>Bi-directional (equivalent):</strong> Comma-separated values on each line</p>
        <code class="bg-blue-100 px-2 py-1 rounded">laptop, computer, pc</code><br/>
        <code class="bg-blue-100 px-2 py-1 rounded">episerver, optimizely</code>
        
        <p class="mb-2 mt-3"><strong>Uni-directional (replacement):</strong> Use arrow notation</p>
        <code class="bg-blue-100 px-2 py-1 rounded">H2O => water</code><br/>
        <code class="bg-blue-100 px-2 py-1 rounded">NYC => New York City, New York, Big Apple</code>
        
        <p class="mt-3 text-xs">Each line represents one synonym entry. Multi-word synonyms are supported.</p>
      </div>
    </div>

    <div id="message" class="hidden mb-6"></div>

    <form id="synonymsForm" class="space-y-6">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label for="synonymSlot" class="block text-sm font-medium text-gray-700 mb-2">
            Synonym Slot
          </label>
          <select 
            id="synonymSlot" 
            name="synonymSlot" 
            class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
          >
            <option value="1">Slot 1 (Default)</option>
            <option value="2">Slot 2</option>
          </select>
          <p class="text-xs text-gray-500 mt-1">Choose which synonym slot to update. You can maintain two separate synonym files per language. NOTE: only slot one is currently supported by the site search.</p>
        </div>

        <div>
          <label for="languageRouting" class="block text-sm font-medium text-gray-700 mb-2">
            Language Routing
          </label>
          <input 
            type="text" 
            id="languageRouting" 
            name="languageRouting" 
            value="en"
            placeholder="en"
            class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
          />
          <p class="text-xs text-gray-500 mt-1">Language locale (default: en). Example: en, sv, etc.</p>
        </div>
      </div>

      <div>
        <label for="synonyms" class="block text-sm font-medium text-gray-700 mb-2">
          Synonyms
        </label>
        <textarea 
          id="synonyms" 
          name="synonyms" 
          rows="15" 
          placeholder="Enter your synonyms here, one entry per line:

laptop, computer, pc
NYC, New York City, New York, Big Apple
H2O => water
Siteseeker, Welcome, Episerver => Optimizely"
          class="w-full p-4 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 font-mono text-sm"
        ></textarea>
        <p class="text-xs text-gray-500 mt-1">
          Enter synonyms in CSV format. Leave empty to clear all synonyms for the selected slot.
        </p>
      </div>

      <button 
        type="submit"
        id="submitBtn"
        class="w-full bg-blue-600 text-white py-3 px-6 rounded-md hover:bg-blue-700 focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors font-medium disabled:bg-gray-400 disabled:cursor-not-allowed"
      >
        <span id="btnText">Upload Synonyms to Optimizely Graph</span>
        <span id="spinner" class="hidden">
          <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white inline" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
          Uploading...
        </span>
      </button>
    </form>
<!-- 
    <div class="mt-8 bg-gray-50 p-4 rounded-md">
      <h3 class="text-lg font-semibold text-gray-800 mb-3">Environment Variables Required</h3>
      <div class="text-sm text-gray-600 space-y-1">
        <p><code class="bg-gray-200 px-2 py-1 rounded">OPTIMIZELY_GRAPH_GATEWAY_URL</code> - Default: https://cg.optimizely.com</p>
        <p><code class="bg-gray-200 px-2 py-1 rounded">OPTIMIZELY_GRAPH_APP_KEY</code> - Your HMAC App Key</p>
        <p><code class="bg-gray-200 px-2 py-1 rounded">OPTIMIZELY_GRAPH_SECRET</code> - Your HMAC Secret (base64 encoded)</p>
      </div>
    </div> -->

    <div class="mt-6 bg-yellow-50 border-l-4 border-yellow-400 p-4">
      <h3 class="text-lg font-semibold text-yellow-800 mb-2">Important Notes</h3>
      <ul class="text-sm text-yellow-700 list-disc list-inside space-y-1">
        <li>Synonyms only work for string fields in GraphQL queries</li>
        <li>Changes are available in near real-time after uploading</li>
        <li>Results matching synonyms are ranked higher than non-matching results</li>
        <li>Exact matches are ranked higher than synonym matches</li>
        <li>Case-sensitive variants should be added as synonyms for eq/in operators</li>
      </ul>
    </div>

    <div class="mt-6 bg-green-50 border-l-4 border-green-400 p-4">
      <h3 class="text-lg font-semibold text-green-800 mb-2">Example Usage in GraphQL</h3>
      <div class="text-sm text-green-700">
        <p class="mb-2">To use synonyms in your GraphQL queries, add the synonyms parameter:</p>
        <pre class="bg-green-100 p-3 rounded text-xs overflow-x-auto"><code>{`
  Content(
    where: {
      _fulltext: {
        match: "H2O",
        synonyms: ONE
      }
    }
  ) {
    items {
      _score
      Name
      MainBody
    }
  }
`}</code></pre>
        <p class="mt-2 text-xs">This will match content containing "water" when you search for "H2O" (if you've set up that synonym).</p>
      </div>
    </div>
  </div>
  
  <script src="/js/synonyms.js" is:inline></script>
</AdminLayout>